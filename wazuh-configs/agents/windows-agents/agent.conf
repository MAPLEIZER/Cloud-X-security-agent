<!-- Shared agent configuration for Windows -->
<agent_config os="windows">

  <!-- Resilience for offline agents -->
  <client_buffer>
    <disabled>no</disabled>
    <queue_size>2048</queue_size>
  </client_buffer>

  <!-- Policy monitoring -->
  <rootcheck>
    <disabled>no</disabled>
    <check_files>yes</check_files>
    <check_trojans>no</check_trojans>
    <check_dev>yes</check_dev>
    <check_sys>yes</check_sys>
    <check_pids>yes</check_pids>
    <check_ports>yes</check_ports>
    <check_if>yes</check_if>
    <frequency>21600</frequency>
  </rootcheck>

  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>1h</interval>
    <scan_on_start>yes</scan_on_start>
    <hardware>yes</hardware>
    <os>yes</os>
    <packages>yes</packages>
    <ports all="yes">yes</ports>
    <processes>yes</processes>
  </wodle>

  <!-- Security Configuration Assessment -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>12h</interval>
  </sca>

  <!-- Osquery integration for advanced endpoint telemetry -->
  <wodle name="osquery">
    <disabled>yes</disabled>
    <run_daemon>yes</run_daemon>
    <logging>
      <path>C:\Program Files\osquery\log</path>
    </logging>
    <config>
      <file>C:\Program Files\osquery\osquery.conf</file>
    </config>
  </wodle>

  <!-- Log collection for critical Windows event channels -->
  <localfile>
    <log_format>eventchannel</log_format>
    <location>Security</location>
  </localfile>

  <localfile>
    <log_format>eventchannel</log_format>
    <location>Microsoft-Windows-PowerShell/Operational</location>
  </localfile>

  <!-- If you run Script Block Logging, youâ€™ll see 4104 here -->
  <localfile>
    <log_format>eventchannel</log_format>
    <location>Microsoft-Windows-PowerShell/Analytic</location>
  </localfile>

  <!-- Optional but highly recommended if Sysmon is installed -->
  <localfile>
    <log_format>eventchannel</log_format>
    <location>Microsoft-Windows-Sysmon/Operational</location>
  </localfile>

  <command>
    <name>disable-account</name>
    <executable>disable-account.cmd</executable>
    <timeout_allowed>yes</timeout_allowed>
    <timeout>60</timeout>
  </command>

  <command>
    <name>firewall-drop</name>
    <executable>firewall-drop.cmd</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <active-response>
    <disabled>no</disabled>
    <command>disable-account</command>
    <location>local</location>
  </active-response>

  <active-response>
    <disabled>no</disabled>
    <command>firewall-drop</command>
    <location>local</location>
  </active-response>

  <syscheck>
    <disabled>no</disabled>

    <!-- Directories to check in real-time with whodata -->
    <directories realtime="yes" report_changes="yes" whodata="yes">C:\Windows\System32</directories>
    <directories realtime="yes" report_changes="yes" whodata="yes">C:\Windows\SysWOW64</directories>
    <directories realtime="yes" report_changes="yes" whodata="yes">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</directories>
    <directories realtime="yes" report_changes="yes" whodata="yes">C:\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</directories>

    <!-- Directories to check periodically -->
    <directories check_all="yes">C:\Program Files</directories>
    <directories check_all="yes">C:\Program Files (x86)</directories>
    <directories check_all="yes">C:\Users\*\Documents</directories>

    <!-- Registry entries to monitor -->
    <registry_entries realtime="yes">
      <entry>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</entry>
      <entry>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</entry>
    </registry_entries>

    <!-- Files to ignore -->
    <ignore>C:\Windows\System32\config</ignore>
    <ignore>C:\Windows\System32\LogFiles</ignore>
    <ignore>C:\Windows\System32\wbem\Repository</ignore>
    <ignore>.log$</ignore>
    <ignore>.tmp$</ignore>

    <!-- Tame FIM noise from high-churn directories -->
    <ignore type="sregex" value="^C:\\Windows\\SoftwareDistribution\\" />
    <ignore type="sregex" value="^C:\\Windows\\Temp\\" />
    <ignore type="sregex" value="^C:\\Users\\[^\\]+\\AppData\\Local\\Temp\\" />
    <ignore type="sregex" value="^C:\\Users\\[^\\]+\\AppData\\Local\\Google\\Chrome\\User Data\\" />
    <ignore type="sregex" value="^C:\\Users\\[^\\]+\\AppData\\Local\\Microsoft\\Windows\\WebCache\\" />
  </syscheck>

  <command>
    <name>remove-threat</name>
    <executable>remove-threat.py</executable>
    <expect>alert_json</expect>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <active-response>
    <command>remove-threat</command>
    <location>local</location>
    <rules_group>virustotal,</rules_group>
    <level>12</level>
  </active-response>

</agent_config>
